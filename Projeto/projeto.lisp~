;;; projeto.lisp
;;; Integracao Fase 1 e Fase 2

;; AJUSTE ESTE CAMINHO PARA A SUA PASTA ANTES DE CORRER:
(hcl:change-directory "C:\Users\guerr\OneDrive\Desktop\Faculdade\IA\ProjetoIA25-26\Projeto")

(compile-file "puzzle.lisp") (load "puzzle")
(compile-file "procura.lisp") (load "procura")
(compile-file "algoritmo.lisp") (load "algoritmo")
(compile-file "jogo.lisp") (load "jogo")

(defparameter *lista-problemas* nil "Lista de tabuleiros carregada do ficheiro")

;; AUXILIARES DE LOG E INPUT
(defun ler-ficheiro (nome-ficheiro)
  (let ((ficheiro "problemas.dat"))
    (if (probe-file ficheiro)
        (with-open-file (in ficheiro :direction :input)
          (setf *lista-problemas* (loop for linha = (read in nil 'eof) until (eq linha 'eof) collect linha))
          (format t "~%Problemas carregados.~%"))
        (format t "~%Erro: ficheiro nao encontrado.~%"))))

(defun escrever-log (resultado alg prob-id)
  (with-open-file (out "log.dat" :direction :output :if-exists :append :if-does-not-exist :create)
    (if (null resultado)
        (format out "~%Data: ~a | Alg: ~a | FALHOU" (get-universal-time) alg)
        (let* ((no (first resultado))
               (g (second resultado)) (e (third resultado)) (tm (fourth resultado))
               (L (no-g no)) (P (penetrancia L g)) (B (ramificacao-media L g)))
          (format out "~%Data: ~a | Prob: ~d | Alg: ~a | Sol: ~d | Nos: ~d | Exp: ~d | T: ~d ms | Pen: ~5,3f | Ram: ~5,3f"
                  (get-universal-time) prob-id alg L g e tm P B)))))

(defun imprimir-tabuleiro (tabuleiro)
  (dolist (linha tabuleiro) (format t " ~a~%" linha)))

(defun mostrar-solucao (resultado)
  (if (null resultado)
      (format t "~%Nenhuma solucao.~%")
      (let* ((no-final (first resultado))
             (caminho nil)
             (atual no-final))
        (loop while atual do (push atual caminho) (setf atual (no-pai atual)))
        (format t "~%--- SOLUCAO --- Passos: ~d | Nos: ~d | Tempo: ~d ms~%" 
                (1- (length caminho)) (second resultado) (fourth resultado))
        (dolist (no caminho)
          (format t "G=~d H=~5,3f~%" (no-g no) (no-heuristica no))
          (imprimir-tabuleiro (no-estado no))
          (format t "---~%")))))

;; MENUS
(defun menu-principal ()
  (if (null *lista-problemas*) (ler-ficheiro "problemas.dat"))
  (format t "~%=== PROJETO IA ===~%")
  (format t "1. Fase 1 (Solitario 1 Jogador)~%")
  (format t "2. Fase 2 (Campeonato 2 Jogadores)~%")
  (format t "0. Sair~%")
  (format t "Opcao: ")
  (let ((op (read)))
    (cond
      ((= op 1) (menu-fase1) (menu-principal))
      ((= op 2) (format t "~%Para jogar campeonato, escreva: (jogar (nth 0 *lista-problemas*) 2000)~%") (menu-principal))
      ((= op 0) (format t "Adeus.~%"))
      (t (menu-principal)))))

(defun menu-fase1 ()
  (format t "~%Problema (1-~d): " (length *lista-problemas*))
  (let ((n (read)))
    (if (and (integerp n) (>= n 1) (<= n (length *lista-problemas*)))
        (let ((tab (nth (1- n) *lista-problemas*)))
          (format t "Algoritmo (1-BFS, 2-DFS, 3-A*): ")
          (let ((alg (read)))
            (let ((res (cond
                         ((= alg 1) (bfs (criar-no tab)))
                         ((= alg 2) (dfs (criar-no tab) 20))
                         ((= alg 3) (a-star (criar-no tab) #'h1-base)))))
              (mostrar-solucao res)
              (escrever-log res alg n))))
        (format t "Invalido."))))